<!DOCTYPE html>
<html>
<head>
<title>Tuner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="../style.css" />
<style>
canvas {display:block;border:1px solid;}
</style>
</head>
<body>

<h1><span id="qr"><a id="qrcode"></a></span> Tuner</h1>
<p>
<button id="btn">start</button>
</p><p>
<canvas id="can"></canvas>
</p><p>
<a href=index.html>Back</a>
</p>

<script>
var audioCtx;
var running;
var btn = document.getElementById('btn');
var out = document.getElementById('out');
var can = document.getElementById('can');
var ctx = can.getContext('2d');
var animationId;
var note = ['A', 'A♯/B♭', 'B', 'C', 'C♯/D♭', 'D', 'D♯/E♭', 'E', 'F', 'F♯/G♭', 'G', 'G♯/A♭'];
async function start() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  stream = await navigator.mediaDevices.getUserMedia({
    audio: true,
    echoCancellation: false,
    noiseSuppression: false,
    autoGainControl: false
  });
  micSource = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.8;
  micSource.connect(analyser);
  running = true;
  btn.innerHTML = 'stop';
  update();
}
function stop() {
  if (audioCtx) {
    audioCtx.close();
    audioCtx = null;
  }
  btn.innerHTML = 'start';
  running = false;
}
btn.addEventListener("click", function() {
  if (running) stop();
  else start().catch(function (err) {
    console.error(err);
    alert("Microphone access failed.");
  });
});
function update() {
  if (!running) return;
  const bufferLength = analyser.frequencyBinCount;
  const buffer = new Float32Array(bufferLength);
  analyser.getFloatTimeDomainData(buffer);

  const data = new Uint8Array(bufferLength);
  analyser.getByteTimeDomainData(data);

  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, can.width, can.height);
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;
  ctx.beginPath();
  var dx = can.width / bufferLength;
  var x = 0, y;
  var i;
  for (i = 0; i < bufferLength; i++) {
    y = can.height / 2 + (data[i] - 128) / 128 * can.height / 2;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
    x += dx;
  }
  ctx.stroke();
  var f = autoCorrelate(buffer, audioCtx.sampleRate);
  if (f) {
    var z = Math.log2(f / 440);
    z = (z - Math.floor(z)) * 12;
    y = can.height / 8;
    x = can.width / 2;
    dx = x * (Math.round(z) - z);
    ctx.font = "16px serif";
    ctx.textAlign = "center";
    ctx.fillStyle = "blue";
    ctx.fillText(note[Math.round(z) % 12], x + dx, y);
    ctx.fillText(note[Math.round(z + 11) % 12], dx, y);
    ctx.fillText(note[Math.round(z + 1) % 12], x + x + dx, y);
    x = dx - x;
    while (x <= can.width) {
      if (x > 0) ctx.fillText('*', x, y * 2);
      x += can.width / 16;
    }
    ctx.fillStyle = "red";
    ctx.fillText('⇑', can.width / 2, y * 3);
  }
  animationId = requestAnimationFrame(update);
}
function autoCorrelate(buffer, sampleRate) {
  var i, j, n, x;
  const a = new Array(buffer.length).fill(0);
  var m = 0;
  for (i = 0; i < buffer.length; i++) {
    if (m < buffer[i]) m = buffer[i];
  }
  x = 0;
  for (i = 0; i < buffer.length; i++) x += buffer[i] * buffer[i];
  if (x < 0.1) return;
  for (i = 0; i < buffer.length; i++) {
    for (j = 0; j < buffer.length - i; j++) {
      a[i] += buffer[j] * buffer[j + i];
    }
  }
  for (n = 12; n < buffer.length; n++) if (a[n] > a[n - 1]) break;
  x = a[n];
  for (i = n; i < buffer.length; i++) if (a[i] > x) { n = i; x = a[i]; }
  return sampleRate / n;
}

</script>

<script src="https://cdn.jsdelivr.net/npm/qr-min"></script>
<script src="../javascript/common.js"></script>
</body>
</html>